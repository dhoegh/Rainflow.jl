using Rainflow
using Test

@testset "Test Rainflow" begin
    
    signal = [0.9706563288552144, -0.9792184115351997, 0.9018608835940937, -0.03280312924463938, -0.6007922233555612, -1.445177115286233, 2.7074239417157804, 1.5244478634355956, 0.759804020007466, -0.8814369061964817, 0.7059931337826102, 1.0915552820534098, 0.871497852880908, 0.08569110900637714, 0.9600791514875388, 0.9078369989365005, -1.4650618695690587, -0.21585927378802833, 0.5750944492583863, -1.7956301592128259, -1.0564985238162532, 0.14836063583704276, -1.8385101712842142, -1.073632485740185, 0.9217661545999248, -1.9218621879132671, 0.23387927284771276, 0.4059124131516725, -0.09587841067791354, 1.5439016235414038, 0.01101291451278319, -0.9035414832281808, 0.40070351919377084, 0.3058468848949851, -1.252895809245693, -0.9423794867830996, -0.45783117562397757, -0.23964239700699727, -1.253709306583179, -0.7534827366032512, 0.12820429210555256, -1.2547515101460296, -0.3088109174960365, 0.1334198226268215, -0.9084363946747751, 1.6528327680128594, 1.0625451376005126, -0.9158616213749127, -0.04954131406750518, 1.4682359438211439, -0.2171717536447572, 1.1681350167537032, -0.7102933499586951, 2.159922938344372, 0.7947494099227463, 0.7201960562663018, 1.4827156137266893, 1.3167919773009253, 0.8783728233114567, 1.724189934074888, -0.2009512454446405, 1.5884326255276218, -0.576838319152116, 1.0033831093590662, 0.40140576412349366, -1.2420280373790664, -0.8758406280335232, 0.5277404615976359, -0.40913070057473955, -0.24571704637997954, -0.7835255201282382, -1.074895226100107, -0.9426675433010124, -0.009097897493950763, 0.5611164207223476, 0.16624468543985357, -0.2487529875317702, 2.9726978811181244, -1.588029026578847, -1.018462898076985, -0.9629889986169936, 0.43757152125602755, -0.34216792782253785, -0.9129974565411761, 0.16719639547216034, -1.2456607427292232, -0.6521452179368953, -0.2929767472126141, 1.349636741671144, 1.131929388859165, -1.363701086274894, -0.06856007422552188, 2.513904980554075, 0.12406168148806979, 0.4420111313490476, 0.6559106447166104, -0.20563037602802728, 0.7707031750912096, -1.2139401711703544, 1.0914985820684815]
    ext, t = sort_peaks(signal)
    result = count_cycles(ext,t)
    bins,_,_ = sum_cycles(result,13,1)
    bins1,_,_ = sum_cycles(result, collect(range(0, 100, length=13+1)), collect(range(0, 100, length=1+1)))
    bins2,_,_ = sum_cycles(result, range(0, 100, length=13+1), range(0, 100, length=1+1))
    Ncycles,meanIntervals,rangeIntervals,equivalentLoad = Rainflow.rainflow(signal;nbins_range=13,nbins_mean=1,m=3,Teq=1)
    @test bins==bins1==bins2==Ncycles
    @test dropdims(bins,dims=2) == [1.0; 3.0; 7.0; 3.0; 5.0; 4.0; 2.0; 3.0; 0.0; 1.5; 0.5; 0.5; 1.5]
    @test isapprox(meanIntervals,[-0.8236347616879119, 1.2221929951706154];atol=1e-5)
    @test isapprox(rangeIntervals,[-4.8945600690313914e-14, 0.3765046206947224, 0.7530092413894448, 1.1295138620841672, 1.5060184827788896, 1.8825231034736123, 2.2590277241683343, 2.635532344863057, 3.0120369655577792, 3.3885415862525012, 3.7650462069472246, 4.141550827641947, 4.518055448336669, 4.89456006903144];atol=1e-5)
    @test isapprox(equivalentLoad,[7.755236235263308];atol=1e-5)
end
